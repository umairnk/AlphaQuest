<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="AlphaQuest">
  <title>AlphaQuest</title>

  <!-- Icons -->
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="favicon.png">
  <link rel="apple-touch-icon" sizes="152x152" href="favicon.png">
  <link rel="apple-touch-icon" sizes="120x120" href="favicon.png">
  <link rel="apple-touch-icon" href="favicon.png">

  <style>
    body {
      font-family: 'Comic Neue', Verdana, Arial, Helvetica, sans-serif;
      background-color: #f0f8ff;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
      position: relative;
    }
    .capital {
      font-size: 150px;
      color: #ff4500;
      text-shadow: 2px 2px 4px #ffd700;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .options {
      display: flex;
      justify-content: space-around;
      width: 80%;
      margin: 20px 0;
    }
    .option {
      font-size: 100px;
      color: #4b0082;
      background-color: #fffacd;
      border: 2px solid #ffd700;
      border-radius: 20px;
      padding: 20px;
      cursor: pointer;
      transition: transform 0.3s;
      text-shadow: 1px 1px 2px #add8e6;
    }
    .option:hover { transform: scale(1.1); }
    .counts, .percent-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      width: 90%;
      font-weight: 700;
      font-size: 20px;
      margin: 10px 0;
      color: #228b22;
    }
    .count-item, .percent-item { margin: 5px; }
    .baskets {
      display: flex;
      justify-content: space-around;
      width: 90%;
      margin: 20px 0;
    }
    .basket-container { width: 22%; text-align: center; }
    .basket-label {
      font-weight: 700;
      font-size: 18px;
      color: #fff;
      background: linear-gradient(45deg, #ff69b4, #ffd700);
      padding: 5px 10px;
      border-radius: 10px;
      margin-bottom: 5px;
      text-shadow: 1px 1px 2px #333;
    }
    .basket {
      width: 100%;
      height: 250px;
      border: 4px solid #8b4513;
      border-radius: 15px;
      background: linear-gradient(45deg, #deb887 25%, #d2b48c 25%, #d2b48c 50%, #deb887 50%, #deb887 75%, #d2b48c 75%, #d2b48c);
      background-size: 20px 20px;
      padding: 10px;
      display: flex;
      flex-wrap: wrap;
      align-content: flex-start;
      overflow-y: auto;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .basket-letter {
      font-size: 30px;
      color: #ff69b4;
      margin: 5px;
      text-shadow: 1px 1px 2px #fff;
      animation: bounce 2s infinite;
    }
    @keyframes bounce {
      0%,100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    #confetti-canvas {
      position: fixed;
      top: 0; left: 0;
      pointer-events: none;
    }
    .red-cross {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      font-size: 100px;
      color: red !important; /* force red */
      z-index: 2000;
      animation: fadeOut 1s forwards;
      pointer-events: none;
    }
    @keyframes fadeOut {
      0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(2); }
    }
    .reset-button {
      font-size: 20px;
      color: #fff;
      background: linear-gradient(45deg, #ff69b4, #ffd700);
      border: 2px solid #8b4513;
      border-radius: 10px;
      padding: 10px 20px;
      cursor: pointer;
      margin-top: 20px;
      text-shadow: 1px 1px 2px #333;
      transition: transform 0.3s;
    }
    .reset-button:hover { transform: scale(1.1); }
  </style>
</head>
<body>
  <div id="capital" class="capital"></div>
  <div id="options" class="options"></div>
  <div id="counts" class="counts"></div>
  <div id="percent-row" class="percent-row"></div>
  <div id="baskets" class="baskets">
    <div class="basket-container"><div class="basket-label">Needs Practice</div><div class="basket" id="basket1"></div></div>
    <div class="basket-container"><div class="basket-label">Getting Better</div><div class="basket" id="basket2"></div></div>
    <div class="basket-container"><div class="basket-label">Almost There</div><div class="basket" id="basket3"></div></div>
    <div class="basket-container"><div class="basket-label">Mastered!</div><div class="basket" id="basket4"></div></div>
  </div>
  <button class="reset-button" onclick="resetStats()">Reset Progress</button>
  <canvas id="confetti-canvas"></canvas>

  <!-- Audio with MP3 + M4A fallback -->
  <audio id="clap" preload="auto">
    <source src="applause.m4a" type="audio/mp4">
    <source src="applause.mp3" type="audio/mpeg">
  </audio>
  <audio id="lose" preload="auto">
    <source src="buzzer.m4a" type="audio/mp4">
    <source src="buzzer.mp3" type="audio/mpeg">
  </audio>

  <script>
    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
    const smallLetters = 'abcdefghijklmnopqrstuvwxyz'.split('');
    const confusers = {A:['o','c','e','q'],B:['d','p','q','o'],C:['o','g','q','e'],D:['b','p','q','o'],E:['c','o','a','q'],F:['t','i','l','j'],G:['q','p','y','o'],H:['n','m','u','b'],I:['l','j','t','f'],J:['i','l','g','y'],K:['x','h','l','y'],L:['i','j','t','f'],M:['n','u','w','v'],N:['m','h','u','r'],O:['c','e','a','q'],P:['q','b','d','o'],Q:['p','g','o','d'],R:['n','h','m','b'],S:['z','c','o','e'],T:['f','i','l','j'],U:['n','m','h','v'],V:['w','u','y','x'],W:['v','m','u','n'],X:['k','y','z','v'],Y:['v','g','j','u'],Z:['s','n','m','x']};

    let stats = JSON.parse(localStorage.getItem('alphabetStats')) || {};
    alphabet.forEach(l=>{ if(!stats[l]) stats[l]={presented:0,correct:0}; });
    let currentCapital,currentCorrect,wrongChoiceMade,hasUpdatedStats;

    const clapAudio=document.getElementById('clap');
    const loseAudio=document.getElementById('lose');

    // Unlock iOS audio on first tap
    function initAudio() {
      [clapAudio, loseAudio].forEach(a=>{
        a.play().then(()=>a.pause()).catch(()=>{});
      });
    }
    document.body.addEventListener('touchstart', initAudio, { once:true });
    document.body.addEventListener('click', initAudio, { once:true });

    function saveStats(){ localStorage.setItem('alphabetStats', JSON.stringify(stats)); }
    function resetStats(){
      if(prompt('Enter password to reset progress:')==='4321'){
        alphabet.forEach(l=>stats[l]={presented:0,correct:0});
        saveStats(); updateCounts(); updateBaskets(); alert('Progress reset!');
      } else alert('Incorrect password!');
    }
    function updateCounts(){
      counts.innerHTML=''; percent-row.innerHTML='';
      const perc=document.getElementById('percent-row'); perc.innerHTML='';
      alphabet.forEach(l=>{
        const s=stats[l]; const c=s.presented; const p=c>0?Math.round((s.correct/c)*100):0;
        counts.innerHTML+=`<div class="count-item">${l}<sub>${c}</sub></div>`;
        perc.innerHTML+=`<div class="percent-item">${l}<sub>${p}</sub></div>`;
      });
    }
    function updateBaskets(){
      const baskets=[basket1,basket2,basket3,basket4]; baskets.forEach(b=>b.innerHTML='');
      alphabet.forEach(l=>{
        const s=stats[l]; if(s.presented>0){
          const p=Math.round((s.correct/s.presented)*100);
          let i= (p<=20)?0:(p<=50)?1:(p<=85)?2:3;
          const d=document.createElement('div'); d.className='basket-letter'; d.textContent=l; baskets[i].appendChild(d);
        }
      });
    }
    function weightedRandomLetter(){
      const min=Math.min(...alphabet.map(l=>stats[l].presented));
      if(min<3){ const c=alphabet.filter(l=>stats[l].presented===min); return c[Math.floor(Math.random()*c.length)]; }
      const probs=[.3,.3,.25,.05],b=[[],[],[],[]];
      alphabet.forEach(l=>{
        const s=stats[l]; const p=s.presented>0?Math.round((s.correct/s.presented)*100):0;
        if(p<=20)b[0].push(l); else if(p<=50)b[1].push(l); else if(p<=85)b[2].push(l); else b[3].push(l);
      });
      let r=Math.random(),c=0,i; for(i=0;i<probs.length;i++){ c+=probs[i]; if(r<c&&b[i].length){return b[i][Math.floor(Math.random()*b[i].length)];}}
      return alphabet[Math.floor(Math.random()*alphabet.length)];
    }
    function generateQuestion(){
      currentCapital=weightedRandomLetter(); currentCorrect=smallLetters[alphabet.indexOf(currentCapital)];
      wrongChoiceMade=false; hasUpdatedStats=false;
      capital.textContent=currentCapital; options.innerHTML='';
      let wrongs=confusers[currentCapital].slice();
      while(wrongs.length<3){ const pool=smallLetters.filter(l=>l!==currentCorrect&&!wrongs.includes(l)); wrongs.push(pool[Math.floor(Math.random()*pool.length)]);}
      currentOptions=[currentCorrect,...wrongs.slice(0,3)].sort(()=>0.5-Math.random());
      currentOptions.forEach(opt=>{
        const d=document.createElement('div'); d.className='option'; d.textContent=opt;
        d.onclick=()=>handleClick(d,opt); options.appendChild(d);
      });
      updateCounts(); updateBaskets();
    }
    function handleClick(el,sel){
      if(sel!==currentCorrect){
        if(!hasUpdatedStats){ wrongChoiceMade=true; stats[currentCapital].presented++; hasUpdatedStats=true; saveStats(); updateCounts(); updateBaskets(); }
        playLose(); showRedCross(); el.remove();
        if(document.querySelectorAll('.option').length===0) setTimeout(generateQuestion,1000);
      } else {
        if(!hasUpdatedStats){ stats[currentCapital].presented++; if(!wrongChoiceMade) stats[currentCapital].correct++; hasUpdatedStats=true; saveStats(); updateCounts(); updateBaskets();}
        celebrate(el); setTimeout(generateQuestion,1000);
      }
    }
    function playClap(){ clapAudio.currentTime=0; clapAudio.play().catch(()=>{}); }
    function playLose(){ loseAudio.currentTime=0; loseAudio.play().catch(()=>{}); }
    function showRedCross(){ const c=document.createElement('div'); c.className='red-cross'; c.textContent='âœ–'; document.body.appendChild(c); setTimeout(()=>c.remove(),1000); }
    function celebrate(el){ playClap(); confetti(el); }
    function confetti(el){
      const canvas=document.getElementById('confetti-canvas'); canvas.width=innerWidth; canvas.height=innerHeight;
      const ctx=canvas.getContext('2d'); const rect=el.getBoundingClientRect();
      const cx=rect.left+rect.width/2, cy=rect.top+rect.height/2, parts=[];
      for(let i=0;i<100;i++){ const a=Math.random()*2*Math.PI,s=Math.random()*5+2;
        parts.push({x:cx,y:cy,vx:Math.cos(a)*s,vy:Math.sin(a)*s,r:Math.random()*4+1,color:`hsl(${Math.random()*360},100%,50%)`,tiltAngle:0,tiltAngleInc:Math.random()*0.07+0.05});}
      const start=Date.now(); (function draw(){
        if(Date.now()-start>1000){ctx.clearRect(0,0,canvas.width,canvas.height);return;}
        ctx.clearRect(0,0,canvas.width,canvas.height);
        parts.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=0.1;p.tiltAngle+=p.tiltAngleInc;
          ctx.beginPath(); ctx.lineWidth=p.r; ctx.strokeStyle=p.color;
          ctx.moveTo(p.x+p.r/4, p.y); ctx.lineTo(p.x, p.y+p.r/4); ctx.stroke();});
        requestAnimationFrame(draw);
      })();
    }

    updateCounts(); updateBaskets(); generateQuestion();
  </script>
</body>
</html>
